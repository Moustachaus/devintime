const Discord = require('discord.js');
const bot = new Discord.Client();
const prefix = '!';
const embedColor = 0xE52B50;

function sendError(message, description) {
    message.channel.send({embed: {
        color: 15158332,
        description: ':x: ' +description
    }});
}

function sendError1(message, description) {
    message.channel.send({embed: {
        color: 15158332,
        description: ':x: ' +description
    }});
}

function clean(text) {
    if (typeof(text) === "string")
      return text.replace(/`/g, "`" + String.fromCharCode(8203)).replace(/@/g, "@" + String.fromCharCode(8203));
    else
        return text;
}

bot.on('message', message => {

    mention = message.mentions.users.first();

    if (message.author.bot) return;
    if (message.content[0] === prefix) {
        let splitMessage = message.content.split(" ");
        //if(splitMessage[0] === '!commande') {
        //    if(splitMessage[1] === 'send') {
        //        if(splitMessage.length === 3)
        //        message.channel.send('Param√®tre: ' + splitMessage[2]);
        //    else 
        //        sendError(message, 'Erreur');
        //    }
        //}

        //if(splitMessage[0] === '!ban') {
        //    if(splitMessage.length === 2)
        //        message.guild.ban(message.mentions.users.first());
        //        else 
        //            sendError(message, 'Erreur');
        //}

        if(splitMessage[0] === '!devintime') {
            if(splitMessage[1] === 'msg') {
                if(splitMessage.length === 4)
                if (mention == null) { return sendError(message, 'Erreur avec la mention') }
                if (message.member.hasPermission("ADMINISTRATOR"))  {
                    mentionMessage = message.content.slice (15);
                    mention.sendMessage (mentionMessage);
                    message.channel.send ("Envoy√©!");
                } else {
                    message.channel.send ("Tu n'as pas la permission de faire √ßa !");
                }
                  }// else {
                    //sendError(message, 'Erreur, mauvais format, veuillez inscrire la commande comme √ßa: "!devintime msg (message)"');
                //}
                //else {
                //    sendError(message, 'Erreur, mauvais format, veuillez inscrire la commande comme √ßa: "!devintime absent (raison + temps)"');
                //}











            else if(splitMessage[1] === 'absent') {
                if(message.member.roles.has("535827594432610336")) {

                    tMessage = message.content.slice (17);

                    var embed1 = new Discord.RichEmbed()
                        .setTitle("Envoy√©!")
                        .setDescription("Absence envoy√©")
                        .addField("Raison de votre absence:", tMessage, true)
                        .setColor("0xFACC2E")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                    var embed2 = new Discord.RichEmbed()
                        .setTitle("Absence re√ßus!")
                        .setDescription("Absence re√ßus")
                        .addField("Raison de l'absence:", tMessage, true)
                        .addField("De:", message.member.user.tag, true)
                        .setColor("0xFACC2E")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")



                    bot.fetchUser('215103685980717057').then((user) => {
                        user.send(embed2);
                    });
                    bot.fetchUser('244832256902823947').then((user) => {
                        user.send(embed2);
                    });
                    message.delete();
                    message.author.send(embed1); 
                }






                if(message.member.roles.has("535828313705283594")) {

                    tMessage = message.content.slice (17);
                    bot.fetchUser('215103685980717057').then((user) => {
                        user.send(embed2);
                    });
                    bot.fetchUser('244832256902823947').then((user) => {
                        user.send(embed2);
                    });
                    message.delete();
                    message.author.send(embed1);
            }







                if(message.member.roles.has("539133325730775081")) {
                    tMessage = message.content.slice (17);
                    bot.fetchUser('215103685980717057').then((user) => {
                        user.send(embed2);
                    });
                    bot.fetchUser('244832256902823947').then((user) => {
                        user.send(embed2);
                    });
                    message.delete();
                    message.author.send(embed1);
            }





                if(message.member.roles.has("539183295959793667")) {
                    tMessage = message.content.slice (17);
                    bot.fetchUser('215103685980717057').then((user) => {
                        user.send(embed2);
                    });
                    bot.fetchUser('244832256902823947').then((user) => {
                        user.send(embed2);
                    });
                    message.delete();
                    message.author.send(embed1);
            }


                if(message.member.roles.has("535827954870124554")) {
                    tMessage = message.content.slice (17);
                    bot.fetchUser('215103685980717057').then((user) => {
                        user.send(tMessage);
                    });
                    bot.fetchUser('244832256902823947').then((user) => {
                        user.send(tMessage);
                    });
                    message.delete();
                    message.author.send(embed1);
            }







        //message.channel.send('Raison de votre absence: ' + splitMessage[2] + ' Temps de votre absence: ' + splitMessage[3]);
    }





            else if(splitMessage[1] === 'admin') {
                if(splitMessage[2] === 'aide') {
                    if(splitMessage.length === 3) {
                        var adminhelp = new Discord.RichEmbed()
                            .setTitle("Aide Admin")
                            .setDescription("test")
                            .addField("Commandes", "!devintime absent (raison avec le temps)", true)
                            .setColor("0xFAAC58")
                            .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
                        message.channel.sendEmbed(adminhelp);
            }
        }
    }


            else if(splitMessage[1] === 'aide') {
                if(splitMessage.length === 2) {
                    var aide = new Discord.RichEmbed()
                        .setTitle("Aide")
                        .setDescription("Voici les commandes disponibles avec le bot")
                        .addField("Commande", "!devintime candidature (votre candidature) dans le salon #üì©-recrutement", true)
                        .addField("Commande", "!devintime commande (votre commande) dans le salon #üì¶-commande-personnalis√©e", true)
                        .setColor("0x4087D4")
                        .setFooter("‚Ä¢ Notre site : https://dev-in-time.com ‚Ä¢")
                    message.channel.sendEmbed(aide);
        }
    }
    
            else if(splitMessage[1] === 'sendcommande') {

                message.delete();

                var commandesende = new Discord.RichEmbed()
                    .setTitle("Envoyer une Commande personnalis√©e")
                    .setDescription("**Vous pouvez faire votre propre commande avec cette commande !**")
                    .addField("‚Ä¢Vous n'avez qu'a √©crire !devintime commande (votre commande)‚Ä¢", "‚Ä¢", true)
                    .setColor("0x2169D3")
                    .setFooter("‚Ä¢ Dev in Time ‚Ä¢")



                message.channel.sendEmbed(commandesende);

            }

            else if(splitMessage[1] === 'commande') {
                if (message.channel.id === '539120346624819210') {
            //var commande = new Discord.RichEmbed()
            //    .setTitle("Commande personnalis√©e envoy√© !")
            //    .setDescription("**Votre commande personnalis√©e √† √©t√© envoy√© !**")
            //    .addField("Regardez dans vos messages priv√© pour plus d'infos !", "‚Ä¢", true)
            //    .setColor("0x42D321")
            //    .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
            //message.channel.sendEmbed(commande);
                    message.delete();
                    commande1 = message.content.slice (19);
                    var commandepv = new Discord.RichEmbed()
                        .setTitle("Commande personnalis√©e envoy√© !")
                        .setDescription("‚Ä¢")
                        .addField("**Voici votre commande:**", commande1, true)
                        .addField("Votre commande est en attente", "Vous receverez un message sous peu!", true)
                        .setColor("0x42D321")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                    var commanderec = new Discord.RichEmbed()
                        .setTitle("Commande personnalis√©e re√ßus !")
                        .setDescription("**Une commande personnalis√©e a √©t√© re√ßus !**")
                        .addField("Commande:", commande1, true)
                        .addField("De:", message.member.user.tag, true)
                        .setColor("0x42D321")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")


                    message.author.send(commandepv);

                

                    bot.fetchUser('215103685980717057').then((user) => {
                        user.sendEmbed(commanderec)
                    });

                } else {

                    commande2 = message.content.slice (19);

                    var aideslon = new Discord.RichEmbed()
                        .setTitle("Il y a eu un probl√®me..")
                        .setDescription("Vous devez envoyer votre commande dans le salon üì¶-commande-personnalis√©e !")
                        .addField("Votre commande", commande2, true)
                        .setColor("0x754A7E")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                    message.author.send(aideslon);
                    message.delete();
                }
            }
            else if(splitMessage[1] === 'candidature') {
                if (message.channel.id === '536540504188518400') {
            //var commande = new Discord.RichEmbed()
            //    .setTitle("Commande personnalis√©e envoy√© !")
            //    .setDescription("**Votre commande personnalis√©e √† √©t√© envoy√© !**")
            //    .addField("Regardez dans vos messages priv√© pour plus d'infos !", "‚Ä¢", true)
            //    .setColor("0x42D321")
            //    .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
            //message.channel.sendEmbed(commande);
                    candid = message.content.slice (22);
                    var candidatureenvoye = new Discord.RichEmbed()
                        .setTitle("Candidature envoy√© !")
                        .setDescription("‚Ä¢")
                        .addField("**Voici votre candidature:**", candid, true)
                        .addField("Votre candidature est en attente", "Vous receverez un message sous peu!", true)
                        .setColor("0x42D321")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                    var candidaturerecus = new Discord.RichEmbed()
                        .setTitle("Candidature re√ßus !")
                        .setDescription("**Une candidature a √©t√© re√ßus !**")
                        .addField("Candidature:", candid, true)
                        .addField("De:", message.member.user.tag, true)
                        .setColor("0x42D321")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")


                    message.author.send(candidatureenvoye);


                    message.delete();

                    bot.fetchUser('215103685980717057').then((user) => {
                        user.sendEmbed(candidaturerecus)
                    });


                }  else {

                    candid1 = message.content.slice (22);

                    var aideslon = new Discord.RichEmbed()
                        .setTitle("Il y a eu un probl√®me..")
                        .setDescription("Vous devez envoyer votre candidature dans le salon #üì©-recrutement !")
                        .addField("Votre candidature", candid1, true)
                        .setColor("0x754A7E")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                    
                    message.author.send(aideslon);
                    message.delete();
                }
            }

            else if(message.content == "!devintime clear") {
                if (message.member.hasPermission("MANAGE_MESSAGES")) {
                    message.channel.fetchMessages()
                       .then(function(list){
                            message.channel.bulkDelete(list);
                        }, function(err){message.channel.send("ERREUR: ERROR CLEARING CHANNEL.")})                        
                }
            }


            else if(splitMessage[1] === '!sendcandid') {
                if(message.member.roles.has("535829349174345728")) {
                    if (message.channel.id === '536540504188518400') {
                        var sendcandid = new Discord.RichEmbed()
                        .setTitle("Envoyer une candidature")
                        .setDescription("Nous sommes actuellement en p√©riode de recrutements. Voici les postes √† combler:")
                        .addField("**-Tout type de d√©veloppeur**", "‚Ä¢", true)
                        .addField("**-Mod√©rateur**", "‚Ä¢", true)
                        .addField("**Vous n'avez qu'a √©crire !devintime candidature (votre candidature)**", "Une question sur un poste ? #üõà-infos-role", true)
                        .setColor("0x060732")
                        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")

                        message.delete();
                        message.channel.sendEmbed(sendcandid);
                    }
            }
        }

            else if (message.content.toLowerCase().startsWith("!devintime new")) {
                const reason = message.content.split(" ").slice(1).join(" ");
                if (!message.guild.roles.exists("name", "Support")) {
                    const embed0 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Skoali`, `Vous devez cr√©e un r√¥le nomm√© Support.`)
                    message.channel.send({ embed: embed0 });
                    return
                }
                if (message.guild.channels.exists("name", "ticket-" + message.author.username)) {
                    const embed1 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Skoali`, `Vous avez d√©j√† un ticket ouvert.`)
                    message.channel.send({ embed: embed1 });
                    return
                }
                message.guild.createChannel(`ticket-${message.author.username}`, "text").then(c => {
                    let role = message.guild.roles.find("name", "Support");
                    let role2 = message.guild.roles.find("name", "@everyone");
                    c.overwritePermissions(role, {
                        SEND_MESSAGES: true,
                        READ_MESSAGES: true
                    });
                    c.overwritePermissions(role2, {
                        SEND_MESSAGES: false,
                        READ_MESSAGES: false
                    });
                    c.overwritePermissions(message.author, {
                        SEND_MESSAGES: true,
                        READ_MESSAGES: true
                    });
                    const embed2 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Dev in Time`, `Ton ticket a √©t√© cr√©√© : ` + c.toString())
                    .setTimestamp();
                    message.channel.send({ embed: embed2 });

                    const embed3 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Bonjour ${message.author.username}!`, `Votre ticket a bien √©t√© ouvert un de nos staff va vous r√©pondre le plus rapidement possible.`)
                    .setTimestamp();
                    c.send({ embed: embed3 });
                }).catch(console.error);
            }
            else if (message.content.toLowerCase().startsWith("!devintime close")) {
                if (!message.channel.name.startsWith(`ticket-`)) {
                    const embed8 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Skaoli`, `Vous devez √™tre dans un salon de ticket.`)
                    message.channel.send({ embed: embed8 });
                    return
                }  

                const embed9 = new Discord.RichEmbed()
                .setColor(embedColor)
                .addField(`Dev in Time`, 'Tapez \`!devintime confirmer\` pour confirmer.')
                message.channel.send({ embed: embed9 })
                .then((m) => {
                message.channel.awaitMessages(response => response.content === '!devintime confirmer', {
                    max: 1,
                    time: 15000,
                    errors: ['time'],
                })
                .then((collected) => {
                    message.channel.delete();
                    })
                    .catch(() => {
                    m.edit('').then(m2 => {
                        m2.delete();
                    }, 3000);
                    });
                });
            }


            else if (message.content.toLowerCase().startsWith("!devintime add")) {
                if (!message.channel.name.startsWith(`ticket-`)) {
                    const embed4 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Dev in Time`, `Vous devez √™tre dans un salon de ticket.`)
                    message.channel.send({ embed: embed4 });
                    return
                }
                addedmember = message.mentions.members.first();
                message.channel.overwritePermissions(addedmember, { SEND_MESSAGES : true, VIEW_CHANNEL : true});
                const embed5 = new Discord.RichEmbed()
                .setColor(embedColor)
                .addField(`Dev in Time`, '**' + addedmember + `** a √©t√© ajout√© au ticket, utilisez la commande [!devintime remove]() pour l\'enlever`)
                message.channel.send({ embed: embed5 });

            }


            else if (message.content.toLowerCase().startsWith("!devintime remove")) {
                if (!message.channel.name.startsWith(`ticket-`)) {
                    const embed6 = new Discord.RichEmbed()
                    .setColor(embedColor)
                    .addField(`Dev in Time`, `Vous devez √™tre dans un salon de ticket.`)
                    message.channel.send({ embed: embed6 });
                    return
                }
                removedmember = message.mentions.members.first();
                message.channel.overwritePermissions(removedmember, { SEND_MESSAGES : false, VIEW_CHANNEL : false});
                const embed7 = new Discord.RichEmbed()
                .setColor(embedColor)
                .addField(`Dev in Time`, '**' + removedmember + '** a √©t√© retir√© du ticket.')
                message.channel.send({ embed: embed7 });
            }

                //var commande = new Discord.RichEmbed()
        //    .setTitle("Commande personnalis√©e envoy√© !")
        //    .setDescription("**Votre commande personnalis√©e √† √©t√© envoy√© !**")
        //    .addField("Regardez dans vos messages priv√© pour plus d'infos !", "‚Ä¢", true)
        //    .setColor("0x42D321")
        //    .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
        //message.channel.sendEmbed(commande);

        //else {
                //if (message.channel.id === '539120346624819210') {
                    //var chatt = new Discord.RichEmbed()
                        //.setTitle("Il y a eu un probl√®me..")
                        //.setDescription("Vous devez envoyer une commande-personnalis√©e avec !devintime commande (votre commande) !")
                        //.addField("Dans le salon #commande-personnalis√©e", "‚Ä¢", true)
                        //.setColor("0xF01013")
                        //.setFooter("‚Ä¢ Dev in Time ‚Ä¢")


                    //message.author.send(chatt);
                    //message.delete
            //}
        //}
            //}




        //else if(splitMessage[0] === '!devintime') {
        //    if(splitMessage[1] === 'commande') {
            
        //var commande = new Discord.RichEmbed()
        //    .setTitle("Commande personnalis√©e envoy√© !")
        //    .setDescription("**Votre commande personnalis√©e √† √©t√© envoy√© !**")
        //    .addField("Regardez dans vos messages priv√© pour plus d'infos !", "‚Ä¢", true)
        //    .setColor("0x42D321")
        //    .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
        //message.channel.sendEmbed(commande);

        //if (message.channel.id === '539120346624819210') {
        //    if(splitMessage[1] === 'commande') {
        //        
        //    } else {
        //        var chatt = new Discord.RichEmbed()
        //            .setTitle("Il y a eu un probl√®me..")
        //           .setDescription("Vous devez envoyer une commande-personnalis√©e avec !devintime commande (votre commande) !")
        //            .addField("‚Ä¢", "‚Ä¢", true)
        //            .setColor("0xF01013")
        //            .setFooter("‚Ä¢ Dev in Time ‚Ä¢")
//
//
        //        message.author.send(chatt);
        //        message.delete();√ß
        //    }
        //}

            



    }


}

if (message.channel.id === '536540504188518400') {
    if(!message.content.toLowerCase().startsWith("!devintime candidature")) {
        var chatt1 = new Discord.RichEmbed()
            .setTitle("Il y a eu un probl√®me..")
            .setDescription("Vous devez envoyer une commande-personnalis√©e avec !devintime commande (votre commande) !")
            .addField("Dans le salon #commande-personnalis√©e", "‚Ä¢", true)
            .setColor("0xF01013")
            .setFooter("‚Ä¢ Dev in Time ‚Ä¢")


        message.author.send(chatt1);
        message.delete();
    }
}

});

//bot.on('messageReactionAdd', (reaction, user) => {
//    if(reaction.emoji.name === "üéâ")
//        if (message.channel.id === '539120346624819210') {
//
//
//
//        }
//
//})


bot.on('guildMemberAdd', member => {

    var msgbvnembed = new Discord.RichEmbed()
        .setTitle("Bienvenue sur Dev in Time !")
        .setDescription("‚Ä¢")
        .addField("Si tu as un probl√®me passe dans le salon #support", "‚Ä¢", true)
        .addField("N'oublie pas de lire les r√®glements !", "‚Ä¢", true)
        .addField("Voici le site https://dev-in-time.com)", "‚Ä¢", true)
        .setColor("0x53DD73")
        .setFooter("‚Ä¢ Dev in Time ‚Ä¢")



    var bvnembed = new Discord.RichEmbed()
        .setTitle("**Un nouveau !**")
        .setDescription("***Nom: ***" + member.user.username)
        .addField("**Membre: **", member.guild.memberCount, false)
        .setColor("0x53DD73")
        .setFooter("‚Ä¢ Bienvenue sur Dev in Time ‚Ä¢")

    member.sendEmbed(msgbvnembed);
    member.guild.channels.get('535822252717899806').sendEmbed(bvnembed);
    member.send("Bienvenue sur Dev in Time **"+ member.user.username + "**, merci d'avoir rejoint le serveur ! Si tu as un probl√®me passe dans le salon #support. **N'oublie pas de lire les r√®glements !**");

    const memberCountChannel = member.guild.channels.find(channel => channel.name.startsWith("Membres :"))
    memberCountChannel.setName(`Membres : ${ member.guild.memberCount } üë•`)
 });



bot.on('guildMemberRemove', member => {
    var byembed = new Discord.RichEmbed()
        .setTitle("Aurevoir !")
        .setDescription("***Nom: ***" + member.user.username)
        .addField("**Membre: **", member.guild.memberCount, false)
        .setColor("0xE61919")
        .setFooter("‚Ä¢ √Ä la prochaine ! ‚Ä¢")

    member.guild.channels.get('535822252717899806').sendEmbed(byembed);

    const memberCountChannel = member.guild.channels.find(channel => channel.name.startsWith("Membres :"))
    memberCountChannel.setName(`Membres : ${ member.guild.memberCount } üë•`)




    




});























bot.on('ready', () => { bot.user.setGame('!devintime aide') })


bot.login(process.env.toek);